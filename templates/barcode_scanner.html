<!DOCTYPE html>
<html lang="tr">

<head>
    <title>{{ .title }}</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/assets/css/style.bundle.css" />
    <script src="/assets/js/scripts.bundle.js"></script>
</head>

<body id="kt_body" class="header-fixed header-tablet-and-mobile-fixed toolbar-enabled">
    <div class="d-flex flex-column flex-root">
        <div class="page d-flex flex-row flex-column-fluid">
            <div class="wrapper d-flex flex-column flex-row-fluid" id="kt_wrapper">
                <!-- Header -->
                <div id="kt_header" class="header align-items-stretch">
                    <div class="container-fluid d-flex align-items-stretch justify-content-between">
                        <div class="d-flex align-items-center d-lg-none ms-n3 me-1" title="Show aside menu">
                            <div class="btn btn-icon btn-active-color-primary w-40px h-40px" id="kt_aside_toggle">
                                <span class="svg-icon svg-icon-2x mt-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none">
                                        <path
                                            d="M21 7H3C2.4 7 2 6.6 2 6V4C2 3.4 2.4 3 3 3H21C21.6 3 22 3.4 22 4V6C22 6.6 21.6 7 21 7Z"
                                            fill="black" />
                                        <path opacity="0.3"
                                            d="M21 14H3C2.4 14 2 13.6 2 13V11C2 10.4 2.4 10 3 10H21C21.6 10 22 10.4 22 11V13C22 13.6 21.6 14 21 14ZM22 20V18C22 17.4 21.6 17 21 17H3C2.4 17 2 17.4 2 18V20C2 20.6 2.4 21 3 21H21C21.6 21 22 20.6 22 20Z"
                                            fill="black" />
                                    </svg>
                                </span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center flex-grow-1 flex-lg-grow-0">
                            <a href="/" class="d-lg-none">
                                <img alt="Logo" src="/assets/media/logos/logo-compact.svg" class="h-30px" />
                            </a>
                        </div>
                        <div class="d-flex align-items-stretch justify-content-between flex-lg-grow-1">
                            <div class="d-flex align-items-stretch" id="kt_header_nav">
                                <div class="header-menu align-items-stretch" data-kt-drawer="true"
                                    data-kt-drawer-name="header-menu"
                                    data-kt-drawer-activate="{default: true, lg: false}" data-kt-drawer-overlay="true"
                                    data-kt-drawer-width="{default:'200px', '300px': '250px'}"
                                    data-kt-drawer-direction="end" data-kt-drawer-toggle="#kt_header_menu_mobile_toggle"
                                    data-kt-swapper="true" data-kt-swapper-mode="prepend"
                                    data-kt-swapper-parent="{default: '#kt_body', lg: '#kt_header_nav'}">
                                    <div class="menu menu-lg-rounded menu-column menu-lg-row menu-state-bg menu-title-gray-700 menu-state-title-primary menu-state-icon-primary menu-state-bullet-primary menu-arrow-gray-400 fw-bold my-5 my-lg-0 align-items-stretch"
                                        id="#kt_header_menu" data-kt-menu="true">
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "dashboard" }}active{{ end }} py-3"
                                                href="/dashboard">
                                                <span class="menu-title">Dashboard</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "customers" }}active{{ end }} py-3"
                                                href="/customers">
                                                <span class="menu-title">Müşteriler</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "products" }}active{{ end }} py-3"
                                                href="/products">
                                                <span class="menu-title">Ürünler</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "orders" }}active{{ end }} py-3"
                                                href="/orders">
                                                <span class="menu-title">Siparişler</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "stock" }}active{{ end }} py-3"
                                                href="/stock">
                                                <span class="menu-title">Stok</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "accounting" }}active{{ end }} py-3"
                                                href="/accounting">
                                                <span class="menu-title">Muhasebe</span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Header -->

                <!-- Content -->
                <div class="content d-flex flex-column flex-column-fluid" id="kt_content">
                    <div class="toolbar" id="kt_toolbar">
                        <div id="kt_toolbar_container" class="container-fluid d-flex flex-stack">
                            <div data-kt-swapper="true" data-kt-swapper-mode="prepend"
                                data-kt-swapper-parent="{default: '#kt_content_container', 'lg': '#kt_toolbar_container'}"
                                class="page-title d-flex align-items-center flex-wrap me-3 mb-5 mb-lg-0">
                                <h1 class="d-flex align-items-center text-dark fw-bolder fs-3 my-1">Barkod Tarama</h1>
                                <span class="h-20px border-gray-300 border-start mx-4"></span>
                                <ul class="breadcrumb breadcrumb-separatorless fw-bold fs-7 my-1">
                                    <li class="breadcrumb-item text-muted">
                                        <a href="/" class="text-muted text-hover-primary">Ana Sayfa</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <span class="bullet bg-gray-300 w-5px h-2px"></span>
                                    </li>
                                    <li class="breadcrumb-item text-muted">
                                        <a href="/stock" class="text-muted text-hover-primary">Stok Yönetimi</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <span class="bullet bg-gray-300 w-5px h-2px"></span>
                                    </li>
                                    <li class="breadcrumb-item text-dark">Barkod Tarama</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="post d-flex flex-column-fluid" id="kt_post">
                        <div id="kt_content_container" class="container-xxl">
                            <div class="row g-5 g-xl-8">
                                <!-- Barkod Tarayıcı -->
                                <div class="col-xl-6">
                                    <div class="card card-xl-stretch mb-xl-8">
                                        <div class="card-header border-0 pt-5">
                                            <h3 class="card-title align-items-start flex-column">
                                                <span class="card-label fw-bolder fs-3 mb-1">Barkod Tarama</span>
                                                <span class="text-muted mt-1 fw-bold fs-7">Kamera ile barkod tarama veya manuel giriş</span>
                                            </h3>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-10">
                                                <div class="d-flex flex-column">
                                                    <div id="barcode-scanner" class="mb-5" style="width: 100%; height: 300px; background-color: #f5f8fa; border-radius: 0.475rem; position: relative;">
                                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                                            <button type="button" class="btn btn-primary" id="startScan">
                                                                <i class="ki-duotone ki-barcode fs-2 me-2"></i>Kamera ile Tara
                                                            </button>
                                                        </div>
                                                        <video id="video" style="width: 100%; height: 100%; object-fit: cover; border-radius: 0.475rem; display: none;"></video>
                                                    </div>
                                                    <div class="d-flex align-items-center mb-5">
                                                        <div class="flex-grow-1">
                                                            <input type="text" class="form-control" id="barcodeInput" placeholder="Barkod numarasını girin veya tarayın">
                                                        </div>
                                                        <div class="ms-3">
                                                            <button type="button" class="btn btn-light-primary" id="searchBarcode">Ara</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Ürün Bilgileri -->
                                <div class="col-xl-6">
                                    <div class="card card-xl-stretch mb-xl-8">
                                        <div class="card-header border-0 pt-5">
                                            <h3 class="card-title align-items-start flex-column">
                                                <span class="card-label fw-bolder fs-3 mb-1">Ürün Bilgileri</span>
                                                <span class="text-muted mt-1 fw-bold fs-7">Taranan ürünün detayları</span>
                                            </h3>
                                        </div>
                                        <div class="card-body">
                                            <div id="productInfo" class="d-none">
                                                <div class="d-flex flex-column mb-5">
                                                    <div class="fw-bolder text-dark fs-5 mb-3">
                                                        <span id="productName">-</span>
                                                    </div>
                                                    <div class="text-muted fs-6 mb-2">
                                                        <span class="fw-bold">Kategori:</span> <span id="productCategory">-</span>
                                                    </div>
                                                    <div class="text-muted fs-6 mb-2">
                                                        <span class="fw-bold">Barkod:</span> <span id="productBarcode">-</span>
                                                    </div>
                                                    <div class="text-muted fs-6 mb-2">
                                                        <span class="fw-bold">Fiyat:</span> <span id="productPrice">-</span> TL
                                                    </div>
                                                    <div class="text-muted fs-6 mb-2">
                                                        <span class="fw-bold">Mevcut Stok:</span> <span id="productStock">-</span> <span id="productUnit">-</span>
                                                    </div>
                                                </div>
                                                <div class="separator my-5"></div>
                                                <div class="d-flex flex-column">
                                                    <h4 class="fw-bolder mb-5">Stok İşlemi</h4>
                                                    <div class="mb-5">
                                                        <label class="form-label">İşlem Tipi</label>
                                                        <select class="form-select" id="movementType">
                                                            <option value="in">Stok Girişi</option>
                                                            <option value="out">Stok Çıkışı</option>
                                                            <option value="adjustment">Stok Düzeltme</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-5">
                                                        <label class="form-label">Miktar</label>
                                                        <input type="number" class="form-control" id="quantity" min="1" value="1">
                                                    </div>
                                                    <div class="mb-5">
                                                        <label class="form-label">Referans</label>
                                                        <input type="text" class="form-control" id="reference" placeholder="Fatura No, Sipariş No, vb.">
                                                    </div>
                                                    <div class="mb-5">
                                                        <label class="form-label">Açıklama</label>
                                                        <textarea class="form-control" id="description" rows="3"></textarea>
                                                    </div>
                                                    <div class="d-flex justify-content-end">
                                                        <button type="button" class="btn btn-primary" id="saveMovement">İşlemi Kaydet</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="noProductInfo" class="d-flex flex-column align-items-center justify-content-center min-h-250px">
                                                <i class="ki-duotone ki-barcode fs-5x text-muted mb-5">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                    <span class="path3"></span>
                                                    <span class="path4"></span>
                                                </i>
                                                <div class="text-muted fs-6 text-center">
                                                    Barkod tarayarak veya girerek ürün bilgilerini görüntüleyin
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Son Taranan Ürünler -->
                            <div class="card mb-5 mb-xl-8">
                                <div class="card-header border-0 pt-5">
                                    <h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bolder fs-3 mb-1">Son Taranan Ürünler</span>
                                        <span class="text-muted mt-1 fw-bold fs-7">Bu oturumda taranan ürünler</span>
                                    </h3>
                                </div>
                                <div class="card-body py-3">
                                    <div class="table-responsive">
                                        <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3" id="scannedProductsTable">
                                            <thead>
                                                <tr class="fw-bolder text-muted">
                                                    <th class="min-w-150px">Ürün Adı</th>
                                                    <th class="min-w-120px">Barkod</th>
                                                    <th class="min-w-100px">Kategori</th>
                                                    <th class="min-w-100px">Stok</th>
                                                    <th class="min-w-100px">Fiyat</th>
                                                    <th class="min-w-100px">İşlem Zamanı</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- JavaScript ile doldurulacak -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Content -->
            </div>
        </div>
    </div>

    <script src="/assets/plugins/global/plugins.bundle.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script>
        $(document).ready(function() {
            let currentProductId = null;
            let scannedProducts = [];
            let codeReader = null;

            // Barkod tarama başlat
            $('#startScan').on('click', function() {
                const video = document.getElementById('video');
                video.style.display = 'block';
                $(this).parent().hide();

                codeReader = new ZXing.BrowserMultiFormatReader();
                codeReader.decodeFromConstraints(
                    { video: { facingMode: "environment" } },
                    video,
                    (result, err) => {
                        if (result) {
                            const barcode = result.getText();
                            $('#barcodeInput').val(barcode);
                            searchBarcode(barcode);
                            
                            // Taramayı durdur
                            if (codeReader) {
                                codeReader.reset();
                                video.style.display = 'none';
                                $('#startScan').parent().show();
                            }
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.error(err);
                        }
                    }
                ).catch((err) => {
                    console.error(err);
                    toastr.error('Kamera erişimi sağlanamadı. Lütfen kamera izinlerini kontrol edin.');
                });
            });

            // Manuel barkod arama
            $('#searchBarcode').on('click', function() {
                const barcode = $('#barcodeInput').val().trim();
                if (barcode) {
                    searchBarcode(barcode);
                } else {
                    toastr.warning('Lütfen bir barkod girin');
                }
            });

            // Enter tuşu ile arama
            $('#barcodeInput').on('keypress', function(e) {
                if (e.which === 13) {
                    const barcode = $(this).val().trim();
                    if (barcode) {
                        searchBarcode(barcode);
                    }
                }
            });

            // Barkod ile ürün arama
            function searchBarcode(barcode) {
                $.ajax({
                    url: '/api/v1/stock/products/barcode',
                    type: 'GET',
                    data: { barcode: barcode },
                    success: function(product) {
                        displayProductInfo(product);
                        addToScannedProducts(product);
                    },
                    error: function(error) {
                        toastr.error('Ürün bulunamadı');
                        $('#noProductInfo').removeClass('d-none');
                        $('#productInfo').addClass('d-none');
                    }
                });
            }

            // Ürün bilgilerini göster
            function displayProductInfo(product) {
                currentProductId = product.id;
                $('#productName').text(product.name);
                $('#productCategory').text(product.category);
                $('#productBarcode').text(product.barcode);
                $('#productPrice').text(product.price.toFixed(2));
                $('#productStock').text(product.stock_quantity);
                $('#productUnit').text(product.unit);

                $('#noProductInfo').addClass('d-none');
                $('#productInfo').removeClass('d-none');
            }

            // Taranan ürünler listesine ekle
            function addToScannedProducts(product) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString();
                
                // Aynı ürün daha önce tarandıysa, tekrar ekleme
                const existingIndex = scannedProducts.findIndex(p => p.id === product.id);
                if (existingIndex !== -1) {
                    scannedProducts.splice(existingIndex, 1);
                }

                // Ürünü listeye ekle
                scannedProducts.unshift({
                    id: product.id,
                    name: product.name,
                    barcode: product.barcode,
                    category: product.category,
                    stock_quantity: product.stock_quantity,
                    price: product.price,
                    unit: product.unit,
                    time: timeStr
                });

                // Tabloyu güncelle
                updateScannedProductsTable();
            }

            // Taranan ürünler tablosunu güncelle
            function updateScannedProductsTable() {
                const tbody = $('#scannedProductsTable tbody');
                tbody.empty();

                scannedProducts.forEach(product => {
                    tbody.append(`
                        <tr>
                            <td>
                                <a href="/products/detail/${product.id}" class="text-dark fw-bolder text-hover-primary d-block fs-6">${product.name}</a>
                            </td>
                            <td>${product.barcode}</td>
                            <td>${product.category}</td>
                            <td>${product.stock_quantity} ${product.unit}</td>
                            <td>${product.price.toFixed(2)} TL</td>
                            <td>${product.time}</td>
                        </tr>
                    `);
                });
            }

            // Stok hareketi kaydet
            $('#saveMovement').on('click', function() {
                if (!currentProductId) {
                    toastr.error('Lütfen önce bir ürün tarayın');
                    return;
                }

                const type = $('#movementType').val();
                const quantity = $('#quantity').val();
                const reference = $('#reference').val();
                const description = $('#description').val();

                // API'ye gönder
                $.ajax({
                    url: '/api/v1/stock/movements',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        product_id: currentProductId,
                        type: type,
                        quantity: parseInt(quantity),
                        reference: reference,
                        description: description
                    }),
                    success: function(response) {
                        toastr.success('Stok hareketi başarıyla kaydedildi');
                        
                        // Ürünün stok miktarını güncelle
                        const currentProduct = scannedProducts.find(p => p.id === currentProductId);
                        if (currentProduct) {
                            if (type === 'in') {
                                currentProduct.stock_quantity += parseInt(quantity);
                            } else if (type === 'out') {
                                currentProduct.stock_quantity -= parseInt(quantity);
                            } else {
                                currentProduct.stock_quantity = parseInt(quantity);
                            }
                            
                            // Görüntülenen ürün bilgisini güncelle
                            $('#productStock').text(currentProduct.stock_quantity);
                            
                            // Tabloyu güncelle
                            updateScannedProductsTable();
                        }
                        
                        // Formu temizle
                        $('#quantity').val(1);
                        $('#reference').val('');
                        $('#description').val('');
                    },
                    error: function(error) {
                        toastr.error('Stok hareketi kaydedilirken bir hata oluştu');
                        console.error(error);
                    }
                });
            });

            // Sayfa kapatılırken kamera bağlantısını kapat
            $(window).on('beforeunload', function() {
                if (codeReader) {
                    codeReader.reset();
                }
            });
        });
    </script>
</body>
</html> 