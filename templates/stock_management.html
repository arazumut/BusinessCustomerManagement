<!DOCTYPE html>
<html lang="tr">

<head>
    <title>{{ .title }}</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/assets/css/style.bundle.css" />
    <script src="/assets/js/scripts.bundle.js"></script>
</head>

<body id="kt_body" class="header-fixed header-tablet-and-mobile-fixed toolbar-enabled">
    <div class="d-flex flex-column flex-root">
        <div class="page d-flex flex-row flex-column-fluid">
            <div class="wrapper d-flex flex-column flex-row-fluid" id="kt_wrapper">
                <!-- Header -->
                <div id="kt_header" class="header align-items-stretch">
                    <div class="container-fluid d-flex align-items-stretch justify-content-between">
                        <div class="d-flex align-items-center d-lg-none ms-n3 me-1" title="Show aside menu">
                            <div class="btn btn-icon btn-active-color-primary w-40px h-40px" id="kt_aside_toggle">
                                <span class="svg-icon svg-icon-2x mt-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none">
                                        <path
                                            d="M21 7H3C2.4 7 2 6.6 2 6V4C2 3.4 2.4 3 3 3H21C21.6 3 22 3.4 22 4V6C22 6.6 21.6 7 21 7Z"
                                            fill="black" />
                                        <path opacity="0.3"
                                            d="M21 14H3C2.4 14 2 13.6 2 13V11C2 10.4 2.4 10 3 10H21C21.6 10 22 10.4 22 11V13C22 13.6 21.6 14 21 14ZM22 20V18C22 17.4 21.6 17 21 17H3C2.4 17 2 17.4 2 18V20C2 20.6 2.4 21 3 21H21C21.6 21 22 20.6 22 20Z"
                                            fill="black" />
                                    </svg>
                                </span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center flex-grow-1 flex-lg-grow-0">
                            <a href="/" class="d-lg-none">
                                <img alt="Logo" src="/assets/media/logos/logo-compact.svg" class="h-30px" />
                            </a>
                        </div>
                        <div class="d-flex align-items-stretch justify-content-between flex-lg-grow-1">
                            <div class="d-flex align-items-stretch" id="kt_header_nav">
                                <div class="header-menu align-items-stretch" data-kt-drawer="true"
                                    data-kt-drawer-name="header-menu"
                                    data-kt-drawer-activate="{default: true, lg: false}" data-kt-drawer-overlay="true"
                                    data-kt-drawer-width="{default:'200px', '300px': '250px'}"
                                    data-kt-drawer-direction="end" data-kt-drawer-toggle="#kt_header_menu_mobile_toggle"
                                    data-kt-swapper="true" data-kt-swapper-mode="prepend"
                                    data-kt-swapper-parent="{default: '#kt_body', lg: '#kt_header_nav'}">
                                    <div class="menu menu-lg-rounded menu-column menu-lg-row menu-state-bg menu-title-gray-700 menu-state-title-primary menu-state-icon-primary menu-state-bullet-primary menu-arrow-gray-400 fw-bold my-5 my-lg-0 align-items-stretch"
                                        id="#kt_header_menu" data-kt-menu="true">
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "dashboard" }}active{{ end }} py-3"
                                                href="/dashboard">
                                                <span class="menu-title">Dashboard</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "customers" }}active{{ end }} py-3"
                                                href="/customers">
                                                <span class="menu-title">Müşteriler</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "products" }}active{{ end }} py-3"
                                                href="/products">
                                                <span class="menu-title">Ürünler</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "orders" }}active{{ end }} py-3"
                                                href="/orders">
                                                <span class="menu-title">Siparişler</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "stock" }}active{{ end }} py-3"
                                                href="/stock">
                                                <span class="menu-title">Stok</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "accounting" }}active{{ end }} py-3"
                                                href="/accounting">
                                                <span class="menu-title">Muhasebe</span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Header -->

                <!-- Content -->
                <div class="content d-flex flex-column flex-column-fluid" id="kt_content">
                    <div class="toolbar" id="kt_toolbar">
                        <div id="kt_toolbar_container" class="container-fluid d-flex flex-stack">
                            <div data-kt-swapper="true" data-kt-swapper-mode="prepend"
                                data-kt-swapper-parent="{default: '#kt_content_container', 'lg': '#kt_toolbar_container'}"
                                class="page-title d-flex align-items-center flex-wrap me-3 mb-5 mb-lg-0">
                                <h1 class="d-flex align-items-center text-dark fw-bolder fs-3 my-1">Stok Yönetimi</h1>
                                <span class="h-20px border-gray-300 border-start mx-4"></span>
                                <ul class="breadcrumb breadcrumb-separatorless fw-bold fs-7 my-1">
                                    <li class="breadcrumb-item text-muted">
                                        <a href="/" class="text-muted text-hover-primary">Ana Sayfa</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <span class="bullet bg-gray-300 w-5px h-2px"></span>
                                    </li>
                                    <li class="breadcrumb-item text-dark">Stok Yönetimi</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="post d-flex flex-column-fluid" id="kt_post">
                        <div id="kt_content_container" class="container-xxl">
                            <!-- Düşük Stok Uyarıları -->
                            {{ if .lowStockProducts }}
                            <div class="card mb-5 mb-xl-8">
                                <div class="card-header border-0 pt-5">
                                    <h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bolder fs-3 mb-1">Düşük Stok Uyarıları</span>
                                        <span class="text-muted mt-1 fw-bold fs-7">{{ len .lowStockProducts }} ürün minimum stok seviyesinin altında</span>
                                    </h3>
                                </div>
                                <div class="card-body py-3">
                                    <div class="table-responsive">
                                        <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3">
                                            <thead>
                                                <tr class="fw-bolder text-muted">
                                                    <th class="min-w-150px">Ürün Adı</th>
                                                    <th class="min-w-120px">Kategori</th>
                                                    <th class="min-w-100px">Mevcut Stok</th>
                                                    <th class="min-w-100px">Min. Stok</th>
                                                    <th class="min-w-100px">Birim</th>
                                                    <th class="min-w-100px text-end">İşlemler</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {{ range .lowStockProducts }}
                                                <tr>
                                                    <td>
                                                        <a href="/products/detail/{{ .ID }}" class="text-dark fw-bolder text-hover-primary d-block fs-6">{{ .Name }}</a>
                                                    </td>
                                                    <td>{{ .Category }}</td>
                                                    <td>
                                                        <span class="text-danger fw-bold d-block fs-7">{{ .StockQuantity }}</span>
                                                    </td>
                                                    <td>{{ .MinStockLevel }}</td>
                                                    <td>{{ .Unit }}</td>
                                                    <td class="text-end">
                                                        <button type="button" class="btn btn-sm btn-light-primary btn-add-stock" data-product-id="{{ .ID }}" data-product-name="{{ .Name }}">
                                                            Stok Ekle
                                                        </button>
                                                    </td>
                                                </tr>
                                                {{ end }}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            {{ end }}

                            <!-- Stok Yönetimi Kartları -->
                            <div class="row g-5 g-xl-8 mb-5">
                                <div class="col-xl-4">
                                    <a href="/stock/movements" class="card bg-light-primary hoverable card-xl-stretch mb-xl-8">
                                        <div class="card-body">
                                            <i class="ki-duotone ki-chart-line-star fs-3x text-primary ms-n1">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                                <span class="path3"></span>
                                            </i>
                                            <div class="text-gray-900 fw-bolder fs-2 mb-2 mt-5">Stok Hareketleri</div>
                                            <div class="fw-bold text-gray-400">Tüm stok giriş ve çıkışlarını görüntüle</div>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-xl-4">
                                    <a href="/stock/barcode" class="card bg-light-success hoverable card-xl-stretch mb-xl-8">
                                        <div class="card-body">
                                            <i class="ki-duotone ki-barcode fs-3x text-success ms-n1">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                                <span class="path3"></span>
                                                <span class="path4"></span>
                                            </i>
                                            <div class="text-gray-900 fw-bolder fs-2 mb-2 mt-5">Barkod Tarama</div>
                                            <div class="fw-bold text-gray-400">Barkod ile hızlı ürün bulma ve stok işlemleri</div>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-xl-4">
                                    <button type="button" id="btnStockAdjustment" class="card bg-light-warning hoverable card-xl-stretch mb-xl-8">
                                        <div class="card-body">
                                            <i class="ki-duotone ki-abstract-26 fs-3x text-warning ms-n1">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                            </i>
                                            <div class="text-gray-900 fw-bolder fs-2 mb-2 mt-5">Stok Düzenleme</div>
                                            <div class="fw-bold text-gray-400">Stok sayımı ve düzeltme işlemleri</div>
                                        </div>
                                    </button>
                                </div>
                            </div>

                            <!-- Tüm Ürünler Tablosu -->
                            <div class="card mb-5 mb-xl-8">
                                <div class="card-header border-0 pt-5">
                                    <h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bolder fs-3 mb-1">Ürün Stok Listesi</span>
                                        <span class="text-muted mt-1 fw-bold fs-7">Toplam {{ len .products }} ürün</span>
                                    </h3>
                                    <div class="card-toolbar">
                                        <button type="button" class="btn btn-sm btn-light-primary" id="btnAddStockMovement">
                                            <i class="ki-duotone ki-plus fs-2"></i>Stok Hareketi Ekle
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body py-3">
                                    <div class="table-responsive">
                                        <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3" id="productsTable">
                                            <thead>
                                                <tr class="fw-bolder text-muted">
                                                    <th class="min-w-150px">Ürün Adı</th>
                                                    <th class="min-w-120px">Kategori</th>
                                                    <th class="min-w-100px">Stok Miktarı</th>
                                                    <th class="min-w-100px">Birim</th>
                                                    <th class="min-w-100px">Barkod</th>
                                                    <th class="min-w-100px text-end">İşlemler</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {{ range .products }}
                                                <tr>
                                                    <td>
                                                        <a href="/products/detail/{{ .ID }}" class="text-dark fw-bolder text-hover-primary d-block fs-6">{{ .Name }}</a>
                                                    </td>
                                                    <td>{{ .Category }}</td>
                                                    <td>
                                                        <span class="{{ if le .StockQuantity .MinStockLevel }}text-danger{{ else }}text-dark{{ end }} fw-bold d-block fs-7">{{ .StockQuantity }}</span>
                                                    </td>
                                                    <td>{{ .Unit }}</td>
                                                    <td>{{ .Barcode }}</td>
                                                    <td class="text-end">
                                                        <button type="button" class="btn btn-icon btn-sm btn-light-primary me-1 btn-add-stock" data-product-id="{{ .ID }}" data-product-name="{{ .Name }}">
                                                            <i class="ki-duotone ki-plus-square fs-2">
                                                                <span class="path1"></span>
                                                                <span class="path2"></span>
                                                                <span class="path3"></span>
                                                            </i>
                                                        </button>
                                                        <button type="button" class="btn btn-icon btn-sm btn-light-danger btn-remove-stock" data-product-id="{{ .ID }}" data-product-name="{{ .Name }}">
                                                            <i class="ki-duotone ki-minus-square fs-2">
                                                                <span class="path1"></span>
                                                                <span class="path2"></span>
                                                                <span class="path3"></span>
                                                            </i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {{ end }}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Content -->
            </div>
        </div>
    </div>

    <!-- Stok Ekleme Modal -->
    <div class="modal fade" id="addStockModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Stok Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="productId">
                    <div class="mb-5">
                        <label class="form-label">Ürün</label>
                        <input type="text" class="form-control" id="productName" disabled>
                    </div>
                    <div class="mb-5">
                        <label class="form-label">Miktar</label>
                        <input type="number" class="form-control" id="quantity" min="1" value="1">
                    </div>
                    <div class="mb-5">
                        <label class="form-label">Referans</label>
                        <input type="text" class="form-control" id="reference" placeholder="Fatura No, Sipariş No, vb.">
                    </div>
                    <div class="mb-5">
                        <label class="form-label">Açıklama</label>
                        <textarea class="form-control" id="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveStockMovement">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stok Çıkarma Modal -->
    <div class="modal fade" id="removeStockModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Stok Çıkar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="removeProductId">
                    <div class="mb-5">
                        <label class="form-label">Ürün</label>
                        <input type="text" class="form-control" id="removeProductName" disabled>
                    </div>
                    <div class="mb-5">
                        <label class="form-label">Miktar</label>
                        <input type="number" class="form-control" id="removeQuantity" min="1" value="1">
                    </div>
                    <div class="mb-5">
                        <label class="form-label">Referans</label>
                        <input type="text" class="form-control" id="removeReference" placeholder="Fatura No, Sipariş No, vb.">
                    </div>
                    <div class="mb-5">
                        <label class="form-label">Açıklama</label>
                        <textarea class="form-control" id="removeDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveRemoveStockMovement">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/plugins/global/plugins.bundle.js"></script>
    <script>
        $(document).ready(function() {
            // DataTable başlat
            $('#productsTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/tr.json',
                },
                order: [[2, 'asc']]
            });

            // Stok Ekleme Modal
            $('.btn-add-stock').on('click', function() {
                const productId = $(this).data('product-id');
                const productName = $(this).data('product-name');
                
                $('#productId').val(productId);
                $('#productName').val(productName);
                $('#addStockModal').modal('show');
            });

            // Stok Çıkarma Modal
            $('.btn-remove-stock').on('click', function() {
                const productId = $(this).data('product-id');
                const productName = $(this).data('product-name');
                
                $('#removeProductId').val(productId);
                $('#removeProductName').val(productName);
                $('#removeStockModal').modal('show');
            });

            // Stok Ekleme Kaydet
            $('#saveStockMovement').on('click', function() {
                const productId = $('#productId').val();
                const quantity = $('#quantity').val();
                const reference = $('#reference').val();
                const description = $('#description').val();

                // API'ye gönder
                $.ajax({
                    url: '/api/v1/stock/movements',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        product_id: parseInt(productId),
                        type: 'in',
                        quantity: parseInt(quantity),
                        reference: reference,
                        description: description
                    }),
                    success: function(response) {
                        // Başarılı olduğunda sayfayı yenile
                        toastr.success('Stok başarıyla eklendi');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    },
                    error: function(error) {
                        toastr.error('Stok eklenirken bir hata oluştu');
                        console.error(error);
                    }
                });

                $('#addStockModal').modal('hide');
            });

            // Stok Çıkarma Kaydet
            $('#saveRemoveStockMovement').on('click', function() {
                const productId = $('#removeProductId').val();
                const quantity = $('#removeQuantity').val();
                const reference = $('#removeReference').val();
                const description = $('#removeDescription').val();

                // API'ye gönder
                $.ajax({
                    url: '/api/v1/stock/movements',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        product_id: parseInt(productId),
                        type: 'out',
                        quantity: parseInt(quantity),
                        reference: reference,
                        description: description
                    }),
                    success: function(response) {
                        // Başarılı olduğunda sayfayı yenile
                        toastr.success('Stok başarıyla çıkarıldı');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    },
                    error: function(error) {
                        toastr.error('Stok çıkarılırken bir hata oluştu');
                        console.error(error);
                    }
                });

                $('#removeStockModal').modal('hide');
            });
        });
    </script>
</body>
</html> 