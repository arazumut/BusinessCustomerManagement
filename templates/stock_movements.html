<!DOCTYPE html>
<html lang="tr">

<head>
    <title>{{ .title }}</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/assets/css/style.bundle.css" />
    <script src="/assets/js/scripts.bundle.js"></script>
</head>

<body id="kt_body" class="header-fixed header-tablet-and-mobile-fixed toolbar-enabled">
    <div class="d-flex flex-column flex-root">
        <div class="page d-flex flex-row flex-column-fluid">
            <div class="wrapper d-flex flex-column flex-row-fluid" id="kt_wrapper">
                <!-- Header -->
                <div id="kt_header" class="header align-items-stretch">
                    <div class="container-fluid d-flex align-items-stretch justify-content-between">
                        <div class="d-flex align-items-center d-lg-none ms-n3 me-1" title="Show aside menu">
                            <div class="btn btn-icon btn-active-color-primary w-40px h-40px" id="kt_aside_toggle">
                                <span class="svg-icon svg-icon-2x mt-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none">
                                        <path
                                            d="M21 7H3C2.4 7 2 6.6 2 6V4C2 3.4 2.4 3 3 3H21C21.6 3 22 3.4 22 4V6C22 6.6 21.6 7 21 7Z"
                                            fill="black" />
                                        <path opacity="0.3"
                                            d="M21 14H3C2.4 14 2 13.6 2 13V11C2 10.4 2.4 10 3 10H21C21.6 10 22 10.4 22 11V13C22 13.6 21.6 14 21 14ZM22 20V18C22 17.4 21.6 17 21 17H3C2.4 17 2 17.4 2 18V20C2 20.6 2.4 21 3 21H21C21.6 21 22 20.6 22 20Z"
                                            fill="black" />
                                    </svg>
                                </span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center flex-grow-1 flex-lg-grow-0">
                            <a href="/" class="d-lg-none">
                                <img alt="Logo" src="/assets/media/logos/logo-compact.svg" class="h-30px" />
                            </a>
                        </div>
                        <div class="d-flex align-items-stretch justify-content-between flex-lg-grow-1">
                            <div class="d-flex align-items-stretch" id="kt_header_nav">
                                <div class="header-menu align-items-stretch" data-kt-drawer="true"
                                    data-kt-drawer-name="header-menu"
                                    data-kt-drawer-activate="{default: true, lg: false}" data-kt-drawer-overlay="true"
                                    data-kt-drawer-width="{default:'200px', '300px': '250px'}"
                                    data-kt-drawer-direction="end" data-kt-drawer-toggle="#kt_header_menu_mobile_toggle"
                                    data-kt-swapper="true" data-kt-swapper-mode="prepend"
                                    data-kt-swapper-parent="{default: '#kt_body', lg: '#kt_header_nav'}">
                                    <div class="menu menu-lg-rounded menu-column menu-lg-row menu-state-bg menu-title-gray-700 menu-state-title-primary menu-state-icon-primary menu-state-bullet-primary menu-arrow-gray-400 fw-bold my-5 my-lg-0 align-items-stretch"
                                        id="#kt_header_menu" data-kt-menu="true">
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "dashboard" }}active{{ end }} py-3"
                                                href="/dashboard">
                                                <span class="menu-title">Dashboard</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "customers" }}active{{ end }} py-3"
                                                href="/customers">
                                                <span class="menu-title">Müşteriler</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "products" }}active{{ end }} py-3"
                                                href="/products">
                                                <span class="menu-title">Ürünler</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "orders" }}active{{ end }} py-3"
                                                href="/orders">
                                                <span class="menu-title">Siparişler</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "stock" }}active{{ end }} py-3"
                                                href="/stock">
                                                <span class="menu-title">Stok</span>
                                            </a>
                                        </div>
                                        <div class="menu-item me-lg-1">
                                            <a class="menu-link {{ if eq .active "accounting" }}active{{ end }} py-3"
                                                href="/accounting">
                                                <span class="menu-title">Muhasebe</span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Header -->

                <!-- Content -->
                <div class="content d-flex flex-column flex-column-fluid" id="kt_content">
                    <div class="toolbar" id="kt_toolbar">
                        <div id="kt_toolbar_container" class="container-fluid d-flex flex-stack">
                            <div data-kt-swapper="true" data-kt-swapper-mode="prepend"
                                data-kt-swapper-parent="{default: '#kt_content_container', 'lg': '#kt_toolbar_container'}"
                                class="page-title d-flex align-items-center flex-wrap me-3 mb-5 mb-lg-0">
                                <h1 class="d-flex align-items-center text-dark fw-bolder fs-3 my-1">Stok Hareketleri</h1>
                                <span class="h-20px border-gray-300 border-start mx-4"></span>
                                <ul class="breadcrumb breadcrumb-separatorless fw-bold fs-7 my-1">
                                    <li class="breadcrumb-item text-muted">
                                        <a href="/" class="text-muted text-hover-primary">Ana Sayfa</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <span class="bullet bg-gray-300 w-5px h-2px"></span>
                                    </li>
                                    <li class="breadcrumb-item text-muted">
                                        <a href="/stock" class="text-muted text-hover-primary">Stok Yönetimi</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <span class="bullet bg-gray-300 w-5px h-2px"></span>
                                    </li>
                                    <li class="breadcrumb-item text-dark">Stok Hareketleri</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="post d-flex flex-column-fluid" id="kt_post">
                        <div id="kt_content_container" class="container-xxl">
                            <!-- Stok Hareketleri Özet Kartları -->
                            <div class="row g-5 g-xl-8 mb-5">
                                <div class="col-xl-4">
                                    <div class="card bg-light-success card-xl-stretch mb-xl-8">
                                        <div class="card-body my-3">
                                            <a href="#" class="card-title fw-bolder text-success fs-5 mb-3 d-block">Stok Girişleri</a>
                                            <div class="py-1">
                                                <span class="text-dark fs-1 fw-bolder me-2">
                                                    <span id="totalStockIn">0</span>
                                                </span>
                                                <span class="fw-bold text-muted fs-7">hareket</span>
                                            </div>
                                            <div class="progress h-7px bg-success bg-opacity-50 mt-7">
                                                <div class="progress-bar bg-success" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-4">
                                    <div class="card bg-light-danger card-xl-stretch mb-xl-8">
                                        <div class="card-body my-3">
                                            <a href="#" class="card-title fw-bolder text-danger fs-5 mb-3 d-block">Stok Çıkışları</a>
                                            <div class="py-1">
                                                <span class="text-dark fs-1 fw-bolder me-2">
                                                    <span id="totalStockOut">0</span>
                                                </span>
                                                <span class="fw-bold text-muted fs-7">hareket</span>
                                            </div>
                                            <div class="progress h-7px bg-danger bg-opacity-50 mt-7">
                                                <div class="progress-bar bg-danger" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-4">
                                    <div class="card bg-light-warning card-xl-stretch mb-5 mb-xl-8">
                                        <div class="card-body my-3">
                                            <a href="#" class="card-title fw-bolder text-warning fs-5 mb-3 d-block">Stok Düzeltmeleri</a>
                                            <div class="py-1">
                                                <span class="text-dark fs-1 fw-bolder me-2">
                                                    <span id="totalStockAdjustment">0</span>
                                                </span>
                                                <span class="fw-bold text-muted fs-7">hareket</span>
                                            </div>
                                            <div class="progress h-7px bg-warning bg-opacity-50 mt-7">
                                                <div class="progress-bar bg-warning" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Stok Hareketleri Tablosu -->
                            <div class="card mb-5 mb-xl-8">
                                <div class="card-header border-0 pt-5">
                                    <h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bolder fs-3 mb-1">Stok Hareketleri</span>
                                        <span class="text-muted mt-1 fw-bold fs-7">Tüm stok giriş ve çıkışları</span>
                                    </h3>
                                    <div class="card-toolbar">
                                        <button type="button" class="btn btn-sm btn-light-primary" id="btnAddStockMovement">
                                            <i class="ki-duotone ki-plus fs-2"></i>Yeni Hareket Ekle
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body py-3">
                                    <div class="table-responsive">
                                        <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3" id="stockMovementsTable">
                                            <thead>
                                                <tr class="fw-bolder text-muted">
                                                    <th class="min-w-100px">Tarih</th>
                                                    <th class="min-w-150px">Ürün</th>
                                                    <th class="min-w-100px">İşlem Tipi</th>
                                                    <th class="min-w-100px">Miktar</th>
                                                    <th class="min-w-150px">Referans</th>
                                                    <th class="min-w-200px">Açıklama</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {{ range .movements }}
                                                <tr>
                                                    <td>{{ .MovementDate.Format "02.01.2006 15:04" }}</td>
                                                    <td>
                                                        <a href="/products/detail/{{ .ProductID }}" class="text-dark fw-bolder text-hover-primary d-block fs-6">{{ .Product.Name }}</a>
                                                    </td>
                                                    <td>
                                                        {{ if eq .Type "in" }}
                                                        <span class="badge badge-light-success">Giriş</span>
                                                        {{ else if eq .Type "out" }}
                                                        <span class="badge badge-light-danger">Çıkış</span>
                                                        {{ else }}
                                                        <span class="badge badge-light-warning">Düzeltme</span>
                                                        {{ end }}
                                                    </td>
                                                    <td>{{ .Quantity }}</td>
                                                    <td>{{ .Reference }}</td>
                                                    <td>{{ .Description }}</td>
                                                </tr>
                                                {{ end }}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Content -->
            </div>
        </div>
    </div>

    <!-- Stok Hareketi Ekleme Modal -->
    <div class="modal fade" id="addStockMovementModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered mw-650px">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Stok Hareketi Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-5">
                        <label class="form-label">Ürün</label>
                        <select class="form-select" id="productSelect">
                            <option value="">Ürün Seçin</option>
                            {{ range .products }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </div>
                    <div class="mb-5">
                        <label class="form-label">İşlem Tipi</label>
                        <select class="form-select" id="movementType">
                            <option value="in">Stok Girişi</option>
                            <option value="out">Stok Çıkışı</option>
                            <option value="adjustment">Stok Düzeltme</option>
                        </select>
                    </div>
                    <div class="mb-5">
                        <label class="form-label">Miktar</label>
                        <input type="number" class="form-control" id="movementQuantity" min="1" value="1">
                    </div>
                    <div class="mb-5">
                        <label class="form-label">Referans</label>
                        <input type="text" class="form-control" id="movementReference" placeholder="Fatura No, Sipariş No, vb.">
                    </div>
                    <div class="mb-5">
                        <label class="form-label">Açıklama</label>
                        <textarea class="form-control" id="movementDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveMovement">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/plugins/global/plugins.bundle.js"></script>
    <script>
        $(document).ready(function() {
            // DataTable başlat
            const table = $('#stockMovementsTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/tr.json',
                },
                order: [[0, 'desc']]
            });

            // Stok hareket tiplerini say
            let inCount = 0;
            let outCount = 0;
            let adjustmentCount = 0;

            {{ range .movements }}
                {{ if eq .Type "in" }}
                    inCount++;
                {{ else if eq .Type "out" }}
                    outCount++;
                {{ else }}
                    adjustmentCount++;
                {{ end }}
            {{ end }}

            // İstatistikleri güncelle
            $('#totalStockIn').text(inCount);
            $('#totalStockOut').text(outCount);
            $('#totalStockAdjustment').text(adjustmentCount);

            // Yeni Hareket Ekle butonu
            $('#btnAddStockMovement').on('click', function() {
                $('#addStockMovementModal').modal('show');
            });

            // Stok Hareketi Kaydet
            $('#saveMovement').on('click', function() {
                const productId = $('#productSelect').val();
                const type = $('#movementType').val();
                const quantity = $('#movementQuantity').val();
                const reference = $('#movementReference').val();
                const description = $('#movementDescription').val();

                if (!productId) {
                    toastr.error('Lütfen bir ürün seçin');
                    return;
                }

                // API'ye gönder
                $.ajax({
                    url: '/api/v1/stock/movements',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        product_id: parseInt(productId),
                        type: type,
                        quantity: parseInt(quantity),
                        reference: reference,
                        description: description
                    }),
                    success: function(response) {
                        // Başarılı olduğunda sayfayı yenile
                        toastr.success('Stok hareketi başarıyla kaydedildi');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    },
                    error: function(error) {
                        toastr.error('Stok hareketi kaydedilirken bir hata oluştu');
                        console.error(error);
                    }
                });

                $('#addStockMovementModal').modal('hide');
            });
        });
    </script>
</body>
</html> 